package com.example.rahat;

import java.io.BufferedWriter;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.io.PrintWriter;
import java.net.InetAddress;
import java.net.Socket;
import java.net.UnknownHostException;
import java.text.SimpleDateFormat;
import java.util.Date;

import android.os.AsyncTask;
import android.provider.Settings.Secure;
import android.text.format.Time;
import android.widget.TextView;

import com.example.rahat.MainActivity;

/* ClientThread extends AsyncTask to handle sending a location message
 * message is sent to the server specified by (sName, sPort)
 * */    
public class ClientTask extends AsyncTask<String, Void, String>{
	
	protected String doInBackground(String... strings){
		String sName = strings[0];
		int sPort = Integer.valueOf(strings[1]);
		String message = strings[2];
		Socket socket;
		try{    			
			//get the current time
			Time now = new Time();
			now.setToNow();
			//get location and package it to send
			    			
			//get server IP and connect to it
			InetAddress serverAddr = InetAddress.getByName(sName);    			
			socket = new Socket(serverAddr, sPort);
			//send the message
			PrintWriter out = new PrintWriter(new BufferedWriter(new OutputStreamWriter(socket.getOutputStream())), true);
			out.println(message);
			socket.close();
			//set the text in the Text View
			return "Location sent @ " + now.format("%H:%M:%S");
			
		} catch(UnknownHostException e1){
			e1.printStackTrace();
			return e1.getMessage();
		} catch (IOException e1){
			e1.printStackTrace();
			return e1.getMessage();
		} catch(Exception e){
			e.printStackTrace();
			return e.getMessage();
		}
	}
	protected void onProgressUpdate(){}

	protected void onPostExecute(String msg){
		dispMsg = msg + "\n" + dispMsg;
		((TextView) findViewById(R.id.text_1)).setText(dispMsg);
	}	
	
}
